# TargControl: Управление календарными событиями

## Описание проекта

**TargControl: Управление календарными событиями** — это веб-приложение, разработанное с использованием Streamlit, для автоматизации создания и удаления календарных событий в системе TargControl. Приложение позволяет загружать данные о событиях из CSV-файла, создавать их в системе, а также удалять существующие события для выбранной локации и диапазона дат. Интерфейс поддерживает настройку таймзоны и требует API-токен для взаимодействия с API TargControl.

## Возможности

- **Создание событий**:
  - Загрузка данных из CSV-файла с информацией о сотрудниках, типах событий и датах.
  - Автоматическое создание календарных событий в TargControl.
  - Проверка корректности данных (ФИО сотрудников, типы событий, формат дат).
  - Поддержка поиска сотрудников по полному ФИО, фамилии и имени или только фамилии.
  - Вывод результатов обработки с указанием успешных и неуспешных операций.

- **Удаление событий**:
  - Выбор локации и диапазона дат для удаления календарных событий.
  - Получение списка сотрудников для выбранной локации и их событий в указанном диапазоне.
  - Удаление всех найденных событий с выводом результатов.

- **Интерфейс**:
  - Удобный интерфейс на базе Streamlit с вкладками для создания и удаления событий.
  - Поддержка выбора таймзоны для корректной обработки дат.
  - Предпросмотр загруженного CSV-файла.
  - Инструкция по созданию CSV-файла с примерами.

## Требования

Для работы приложения необходимо установить следующие зависимости:

```bash
pip install -r requirements.txt
```

Содержимое файла `requirements.txt`:

```
streamlit~=1.46.1
requests~=2.32.4
pandas~=2.3.1
pytz~=2025.2
```

## Установка и запуск

1. **Клонируйте репозиторий** (или скачайте файлы проекта):
   ```bash
   git clone <URL_репозитория>
   cd <папка_проекта>
   ```

2. **Создайте виртуальное окружение** (опционально, но рекомендуется):
   ```bash
   python -m venv venv
   source venv/bin/activate  # На Windows: venv\Scripts\activate
   ```

3. **Установите зависимости**:
   ```bash
   pip install -r requirements.txt
   ```

4. **Запустите приложение**:
   ```bash
   streamlit run app.py
   ```

5. Откройте приложение в браузере по адресу `http://localhost:8501`.

## Использование

1. **Ввод API-токена**:
   - Введите действующий API-токен TargControl в соответствующее поле. Без токена приложение не сможет взаимодействовать с API.

2. **Выбор таймзоны**:
   - Выберите нужную таймзону из выпадающего списка (по умолчанию — `Europe/Moscow`).

3. **Создание событий**:
   - Перейдите на вкладку **Создать события**.
   - Загрузите CSV-файл, соответствующий описанной в приложении структуре (см. инструкцию в интерфейсе).
   - Нажмите **Загрузить и создать события** для обработки файла и создания событий.
   - Результаты обработки (успехи и ошибки) будут отображены в интерфейсе.

4. **Удаление событий**:
   - Перейдите на вкладку **Удалить события**.
   - Выберите локацию из списка.
   - Укажите диапазон дат для удаления событий.
   - Нажмите **Удалить события** для выполнения операции.
   - Результаты удаления (успехи и ошибки) будут отображены в интерфейсе.

5. **Очистка кэша**:
   - Используйте кнопку **Очистить кэш и обновить данные** для сброса кэшированных данных и повторной загрузки информации из API.

## Формат CSV-файла

CSV-файл для создания событий должен иметь следующие столбцы (разделитель — `;`):
- **Фамилия** (обязательно): Фамилия сотрудника, должна совпадать с данными в TargControl.
- **Имя** (необязательно): Имя сотрудника.
- **Отчество** (необязательно): Отчество сотрудника.
- **Тип** (обязательно): Тип календарного события (например, "Отпуск"), должен точно совпадать с типом в TargControl.
- **Дата1** (обязательно): Дата начала события в формате `DD/MM/YY` (например, `14/08/25`).
- **Дата2** (обязательно): Дата окончания события в формате `DD/MM/YY` (например, `30/08/25`).

**Пример CSV-файла**:

```csv
Фамилия;Имя;Отчество;Тип;Дата1;Дата2
Иванов;Александр;Константинович;Отпуск;14/08/25;30/08/25
Петрова;Виктория;;Отпуск;30/06/25;13/07/25
Сидорова;;;Отпуск;01/07/25;14/07/25
```

Подробная инструкция по созданию CSV-файла доступна в интерфейсе приложения (раздел "Инструкция по созданию CSV-файла").

## Зависимости от API TargControl

Приложение взаимодействует с API TargControl через следующие эндпоинты:
- Получение типов календарных событий: `GET /external/api/employee-schedules/calendar/types`
- Получение списка сотрудников: `GET /external/api/employees/query`
- Создание календарного события: `POST /external/api/employee-schedules/calendar/create`
- Получение списка локаций: `GET /external/api/locations`
- Получение календарных событий: `POST /external/api/employee-schedules/calendar/query`
- Удаление календарного события: `DELETE /external/api/employee-schedules/calendar/delete/{calendarEventId}`

Для корректной работы требуется действующий API-токен и доступ к API TargControl.

## Обработка ошибок

- **Ошибки API**: Приложение отображает ошибки, связанные с некорректным API-токеном, недоступностью API или неверными данными.
- **Ошибки CSV**: Проверяется структура файла, наличие обязательных столбцов и корректность дат.
- **Ошибки сотрудников**: Если сотрудник не найден в системе или уволен, событие для него не создается, а в результатах отображается предупреждение.

## Ограничения

- Приложение требует точного совпадения данных сотрудников (ФИО) и типов событий с данными в TargControl.
- Даты в CSV-файле должны быть в формате `DD/MM/YY`.
- Удаление событий выполняется только для выбранной локации и диапазона дат.
- Приложение не поддерживает редактирование существующих событий.
