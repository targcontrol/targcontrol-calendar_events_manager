# TargControl: Управление календарными событиями

---

## Краткое описание

Веб-приложение на **Streamlit** для массового **создания** и **удаления** календарных событий в **TargControl**:

* загрузка событий из CSV **или** ручной ввод через встроенную таблицу;
* проверка ФИО, типов событий и дат;
* конвертация дат в выбранную таймзону и далее в UTC;
* удаление событий по выбранной **локации** и интервалу дат.

Приложение работает по API TargControl и требует действительный **API-токен**.

---

## Особенности и возможности

### Создание событий

* Источники данных:

  * **CSV-файл** (авто-определение `;`/`,` и `utf-8-sig`/`utf-8`/`latin-1`, предпросмотр).
  * **Форма (таблица)** в интерфейсе с выпадающим списком типов событий и DatePicker для дат.
* Валидация:

  * обязательные поля: **Фамилия**, **Тип**, **Дата1**, **Дата2**;
  * тип события должен существовать в справочнике TargControl;
  * поиск сотрудника по ФИО с логикой:

    * если заданы *Фамилия + Имя + Отчество* → точное совпадение ФИО;
    * если *Фамилия + Имя* → поиск по паре;
    * если только *Фамилия* → поиск только по фамилии.
* Даты:

  * принимаются форматы: `DD/MM/YY`, `DD/MM/YYYY`, `YYYY-MM-DD`;
  * **Дата1** = начало суток (00:00:00), **Дата2** = конец суток (23:59:59);
  * все значения локализуются в выбранную таймзону и отправляются в API как UTC ISO.
* Создаваемые события:

  * `allDay = true`, `confirmed = true`, комментарий: *«Запланировано автоматически через Streamlit»*.

### Удаление событий

* Выбор **локации** (подтягивается из `/external/api/locations`).
* Задание интервала с точностью до дня (в локальной TZ):

  * начало = 00:00:00, окончание = 23:59:59.999999;
  * конвертация в UTC перед запросами.
* Лимит по сотрудникам:

  * сотрудники фильтруются по `locationIds` выбранной локации;
  * удаляются **все** события найденных сотрудников в указанном интервале.

### Интерфейс

* Вкладки: **Создать события** и **Удалить события**.
* Предпросмотр CSV перед обработкой.
* Кнопка **«Очистить кэш и обновить данные»** для сброса данных, загруженных ранее.
* Фиксированный верхний бар с логотипом (если `logo.png` найден).

---

## Требования

Файл `requirements.txt`:

```
streamlit~=1.46.1
requests~=2.32.4
pandas~=2.3.1
pytz~=2025.2
```

Установка зависимостей:

```bash
pip install -r requirements.txt
```

---

## Установка и запуск

1. Склонируйте репозиторий и перейдите в папку проекта:

   ```bash
   git clone <URL_репозитория>
   cd <папка_проекта>
   ```

2. (Опционально) создайте и активируйте виртуальное окружение:

   ```bash
   python -m venv venv
   # Windows:
   venv\Scripts\activate
   # macOS/Linux:
   source venv/bin/activate
   ```

3. Установите зависимости:

   ```bash
   pip install -r requirements.txt
   ```

4. Проверьте базовые настройки в коде:

   * Константа `DOMAIN` (по умолчанию `'dev'`):

     ```python
     DOMAIN = 'dev'  # https://{DOMAIN}.targcontrol.com
     ```

     При необходимости укажите нужный контур (`staging`, `cloud`, и т.п.).

5. Запустите приложение:

   ```bash
   streamlit run app.py
   ```

6. Откройте браузер: `http://localhost:8501`.

---

## Использование

### 1) API-токен и таймзона

* Введите **API-токен** TargControl (поле с типом `password`).
* Выберите **таймзону** (по умолчанию `Europe/Moscow`).
  Все даты из CSV/таблицы трактуются как локальные в выбранной TZ и конвертируются в UTC перед отправкой.

### 2) Создание событий

* Перейдите во вкладку **Создать события**.
* Выберите источник:

  * **CSV-файл** → загрузите файл и нажмите **«Загрузить и создать события»**.
  * **Форма (таблица)** → заполните строки и нажмите **«Создать события из таблицы»**.
* Посмотрите результаты: успешные операции отмечаются зелёным, ошибки/пропуски — красным.
  Внизу отображается сводка: всего строк, создано, пропущено/с ошибкой.

### 3) Удаление событий

* Перейдите во вкладку **Удалить события**.
* Выберите **локацию** (подтягивается из API) и укажите **диапазон дат**.
* Нажмите **«Удалить события»**.
  Приложение:

  1. найдёт сотрудников выбранной локации,
  2. запросит их события в интервале,
  3. поштучно удалит найденные события, показав лог результата.

### 4) Очистка кэша

* Нажмите **«Очистить кэш и обновить данные»**, если нужно заново подтянуть справочники (типы событий, сотрудники, локации).

---

## Формат CSV

Минимальный набор столбцов (регистр важен — как в примере):

* **Фамилия** *(обязательно)*
* **Имя** *(необязательно)*
* **Отчество** *(необязательно)*
* **Тип** *(обязательно)* — точное совпадение с типом событий в TargControl
* **Дата1** *(обязательно)* — дата начала
* **Дата2** *(обязательно)* — дата окончания

Поддерживаются разделители `;` и `,`. Кодировки: `utf-8-sig`, `utf-8`, `latin-1`.

**Пример:**

```csv
Фамилия;Имя;Отчество;Тип;Дата1;Дата2
Иванов;Александр;Константинович;Отпуск;14/08/25;30/08/25
Петрова;Виктория;;Отпуск;30/06/25;13/07/25
Сидорова;;;Командировка;01/07/2025;14/07/2025
```

> В таблице UI даты можно вводить через picker; при программном вводе строкой допустимы `DD/MM/YY`, `DD/MM/YYYY`, `YYYY-MM-DD`.

---

## Используемые эндпоинты API TargControl

* Справочник типов событий:
  `GET /external/api/employee-schedules/calendar/types`
* Список сотрудников:
  `GET /external/api/employees/query`
* Справочник локаций:
  `GET /external/api/locations`
* Создание события:
  `POST /external/api/employee-schedules/calendar/create`
* Поиск событий:
  `POST /external/api/employee-schedules/calendar/query`
* Удаление события:
  `DELETE /external/api/employee-schedules/calendar/delete/{calendarEventId}`

Все запросы сопровождаются заголовком `X-API-Key: <ваш_токен>` и `Content-Type: application/json`.

---

## Поведение и нюансы

* **События создаются как «весь день»**: `allDay = true`, `confirmed = true`.
* **Дата1/Дата2** трактуются как **полные дни** (00:00:00 → 23:59:59) и конвертируются из выбранной TZ в UTC.
* **Поиск сотрудников**:

  * строится словарь с возможными ключами: `"Фамилия Имя Отчество"`, `"Фамилия Имя"`, `"Фамилия"`;
  * при совпадении берётся `id` сотрудника.
* **Фильтрация сотрудников по локации** при удалении: используется поле `locationIds` у сотрудника.
* **Обработка «уволен»**: если API возвращает текст вида `Employee ... is fired`, строка пропускается с предупреждением.

---

## Обработка ошибок и диагностика

* **Ошибки API**: отображаются с HTTP-кодом и текстом ответа.
* **Ошибки CSV**:

  * отсутствие обязательных столбцов;
  * некорректные даты → предупреждение *«Неверный формат даты…»*;
  * неизвестный тип события → пропуск строки.
* **Сотрудник не найден**: строка помечается как пропущенная.
* **Нет сотрудников в локации** (для удаления): операция прерывается сообщением об ошибке.
* **Кэш**: при несоответствиях справочников используйте кнопку **очистки кэша**.

---

## Безопасность

* Храните **API-токен** в секрете. Не коммитьте токены в VCS.
* При деплое добавьте защиту приложения (VPN, Basic Auth, reverse proxy с ACL и т.п.).
* При необходимости вынесите `DOMAIN` и токен в переменные окружения.

---

## Конфигурация

В коде заданы константы URL на основе `DOMAIN`:

```python
DOMAIN = 'dev'  # поменяйте при необходимости

URL_CALENDAR_TYPES   = f'https://{DOMAIN}.targcontrol.com/external/api/employee-schedules/calendar/types'
URL_EMPLOYEES        = f'https://{DOMAIN}.targcontrol.com/external/api/employees/query'
URL_CREATE_SCHEDULE  = f'https://{DOMAIN}.targcontrol.com/external/api/employee-schedules/calendar/create'
URL_LOCATIONS        = f'https://{DOMAIN}.targcontrol.com/external/api/locations'
URL_CALENDAR_EVENTS  = f'https://{DOMAIN}.targcontrol.com/external/api/employee-schedules/calendar/query'
URL_DELETE_EVENT     = f'https://{DOMAIN}.targcontrol.com/external/api/employee-schedules/calendar/delete/{{calendarEventId}}'
```

> Рекомендуется параметризовать `DOMAIN` через переменные окружения или `st.secrets` для разных контуров.

---

## Ограничения

* Редактирование **существующих** событий не поддерживается (только создание и удаление).
* Требуется **точное** соответствие названий типов событий из TargControl.
* Разрешение неоднозначностей ФИО (например, однофамильцы) не реализовано: берётся первое совпадение по ключам, сформированным из ФИО.
* Удаление действует **на всех** сотрудников выбранной локации в интервале — без дополнительной фильтрации по типам.

---

## Примеры сценариев

### Массовый отпуск по CSV

1. Экспортируйте список сотрудников и подготовьте CSV с колонками из раздела «Формат CSV».
2. Загрузите файл и нажмите **«Загрузить и создать события»**.
3. Проверьте отчёт: строки с ошибками исправьте и перезагрузите файл.

### Очистка событий за квартал по цеху

1. Перейдите во вкладку **Удалить события**.
2. Выберите локацию, например «Цех Литья ПВХ».
3. Укажите даты квартала.
4. Нажмите **«Удалить события»** и просмотрите лог.

---

## Частые вопросы (FAQ)

**Почему даты «съезжают» на день?**
Проверьте выбранную таймзону: даты считаются полуночью локальной TZ и переводятся в UTC.

**Тип события есть в системе, но сервис пишет «Тип … не найден»?**
Проверьте **точное** совпадение регистра/пробелов/символов. Обновите кэш (кнопка в UI) и повторите.

**Сотрудник не найден, хотя он точно есть?**
Сверьте ФИО в TargControl. При необходимости используйте полное ФИО (Фамилия Имя Отчество) в CSV.

**Как удалить только «Отпуск»?**
Сейчас удаление выполняется для **всех типов**. Можно расширить код, добавив фильтр по `typeId` при запросе/удалении.

Если понадобится, могу подготовить короткую `README.md`-версию этой документации или пример `.env`/`st.secrets` для конфигурации `DOMAIN` и ключа.
